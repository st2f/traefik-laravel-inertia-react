name: Inertia Build, Deploy Test Server & E2E

concurrency:
  group: production
  cancel-in-progress: true

on:
  push:
    branches: [main, testing]

env:
  SERVER_USER: ${{ secrets.SERVER_USER }}
  SERVER_IP: ${{ secrets.SERVER_IP }}
  SSH_KEY_VPS: ${{ secrets.SSH_KEY_VPS }}
  SERVER_DESTINATION_DIR: /app/website2/

jobs:

  prepare-dist:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - name: Setup per-repo DIST folder
        run: |
          DIST_ROOT=/dist/${GITHUB_REPOSITORY//\//_}
          rm -Rf "$DIST_ROOT"
          mkdir -p "$DIST_ROOT"
          cp -R * "$DIST_ROOT/"

  install-deps:
    needs: prepare-dist
    runs-on: self-hosted
    strategy:
      matrix:
        type: [ node, php ]
    steps:
      - uses: actions/checkout@v4
      - name: Install dependencies with local hash cache
        uses: ./.github/actions/dependency-cache
        with:
          dist_root: /dist/${GITHUB_REPOSITORY//\//_}
          cache_root: /cache/${GITHUB_REPOSITORY//\//_}
          type: ${{ matrix.type }}

  build-assets:
    needs: install-deps
    runs-on: self-hosted
    steps:
      - name: Build front-end assets
        run: |
          DIST_ROOT=/dist/${GITHUB_REPOSITORY//\//_}
          cd "$DIST_ROOT"
          echo $DIST_ROOT
          npm run build

  unit-tests:
    needs: build-assets
    runs-on: self-hosted
    steps:
      - name: Run unit tests
        run: |
          DIST_ROOT=/dist/${GITHUB_REPOSITORY//\//_}
          cd "$DIST_ROOT"
          echo $DIST_ROOT
          export LARAVEL_BYPASS_ENV_CHECK=1
          npm run test

  deploy-test:
    needs: unit-tests
    runs-on: self-hosted
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      - name: Verify build artifacts
        run: |
          DIST_ROOT=/dist/${GITHUB_REPOSITORY//\//_}
          for dir in node_modules vendor public/build; do
            if [ ! -d "$DIST_ROOT/$dir" ]; then
              echo "❌ Missing: $DIST_ROOT/$dir"
              exit 1
            fi
          done
          echo "✅ All required build artifacts present."
      - name: Deploy via rsync
        run: |
          set -e
          DIST_ROOT=/dist/${GITHUB_REPOSITORY//\//_}
          mkdir -p ~/.ssh
          eval $(ssh-agent -s)
          ssh-add - <<< "$SSH_KEY_VPS"
          ssh-keyscan -t rsa -H $SERVER_IP >> ~/.ssh/known_hosts
          rsync -rhz --delay-updates --stats --delete-before --exclude-from=./.exclude-rsync \
            "$DIST_ROOT/" "$SERVER_USER@$SERVER_IP:$SERVER_DESTINATION_DIR"

  e2e-tests:
    needs: deploy-test
    runs-on: self-hosted
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      - name: Load CI environment variables
        run: cp .env-ci /dist/${GITHUB_REPOSITORY//\//_}/.env
      - name: Install Playwright browsers
        run: |
          DIST_ROOT=/dist/${GITHUB_REPOSITORY//\//_}
          cd "$DIST_ROOT"
          npx playwright install chromium
      - name: Run Playwright tests
        run: |
          DIST_ROOT=/dist/${GITHUB_REPOSITORY//\//_}
          cd "$DIST_ROOT"
          npx playwright test
      - name: Upload Playwright report on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: /dist/${GITHUB_REPOSITORY//\//_}/playwright-report/
